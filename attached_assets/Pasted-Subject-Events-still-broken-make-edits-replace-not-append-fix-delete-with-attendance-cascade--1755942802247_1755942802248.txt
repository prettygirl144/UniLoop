Subject: Events still broken — make edits replace (not append), fix delete with attendance cascade, enforce eligibility, add logs, and run a repair

Context
- As Admin with correct permissions, cannot delete some events.
- Editing targets (batch/section checkboxes) appends to existing arrays instead of replacing them.
- Event cards show as eligible to everyone.
- Each event should have a linked Attendance Sheet; linkage got broken during prior fixes.

Objective
- Edit: replace targets atomically.
- Delete: remove event and its attendance sheet (and rows) safely.
- Feed: only targeted users see events as eligible.
- Repair: backfill any missing attendance sheets.
- Add temporary logs/assertions to prove behavior.

Please implement the following backend + frontend changes.

Backend

1) Guarded routes
- Ensure manage permission (or admin role) is required for POST, PATCH, DELETE /api/events and for attendance mutations.
- User-facing GET /api/events must filter by eligibility for non-admin users.

2) Normalize and replace targets on create/update
- Utility:
  function norm(arr) {
    return [...new Set((arr || []).map(x => x.trim()))].filter(Boolean).sort();
  }
- In POST and PATCH:
  const newTargets = {
    batches: norm(body.targets?.batches),
    sections: norm(body.targets?.sections),
    programs: norm(body.targets?.programs),
  };
  // Replace, do NOT merge/append:
  event.targets = newTargets;
  persist with a transaction.

- After saving, read back and assert equality:
  const saved = await events.get(id);
  assert.deepStrictEqual(saved.targets, newTargets, 'Targets must match exactly');

- Add a structured log:
  log.info({ eventId: id, before: prev.targets, after: newTargets, requestId }, 'EVENT_PATCH_TARGETS');

3) Eligibility filtering in GET /api/events (user feed)
- For non-admins:
  eligible =
    user.batch in event.targets.batches
    && (event.targets.sections.length === 0 || user.section in event.targets.sections)
    && (!event.targets.programs?.length || event.targets.programs.includes(user.program));

- Return only eligible events (or include eligible: true/false and filter in controller).

4) Attendance linkage and delete cascade
- Schema: AttendanceSheet has unique eventId.
- On POST (create event): upsert a sheet by eventId (create if missing).
- On PATCH: keep sheet; optionally store a copy of targets in sheet metadata.
- On DELETE /api/events/:id:
  - Begin transaction
  - Delete attendance rows by sheetId (if any)
  - Delete attendance sheet by eventId (ignore if not found)
  - Delete event
  - Commit
  - Log:
    log.info({ eventId, sheetFound, rowsDeleted, requestId }, 'EVENT_DELETE_CASCADE');

5) One-time repair for missing sheets (idempotent)
- Admin-only script/endpoint:
  for each event:
    if no sheet by eventId:
      create sheet { eventId, createdAt: now(), metaTargets: event.targets }
      log.warn({ eventId }, 'REPAIRED_MISSING_SHEET');

Frontend

6) Edit form must send full replacement arrays
- On submit, send:
  {
    ...otherFields,
    targets: {
      batches: Array.from(selectedBatches),
      sections: Array.from(selectedSections),
      programs: Array.from(selectedPrograms),
    }
  }
- Do NOT send diffs or toggle flags; always the complete selection.

7) Delete action and cache invalidation
- On successful DELETE:
  - Invalidate/refetch:
    ['events','adminList'], ['events','userFeed'], ['events', eventId], ['attendance', eventId]
  - Navigate to the events list with a success toast.

8) Event card eligibility badge
- If server returns eligible, use it; otherwise compute with the same rule as backend and only show “Eligible” when true.

Diagnostics (temporary, then remove)

9) Add requestId and logs
- Include a requestId header/field and print it in all create/edit/delete logs so we can trace a run.

10) Quick integration tests to run manually
- Create event targeted to MBA 2024-26 A. As that user: card shows Eligible; as different batch: event hidden.
- Edit same event to MBA 2025-27 B by unchecking old and checking new:
  - Fetch event → targets exactly equal to the new arrays (no leftovers).
  - Logs show EVENT_PATCH_TARGETS with before/after.
- Delete the event:
  - Fetch → 404; sheet removed; logs show EVENT_DELETE_CASCADE with rowsDeleted count.

Acceptance criteria
- Deleting an event succeeds and removes its attendance sheet/rows (or skips gracefully if missing).
- Editing targets fully replaces previous selections; no accumulation.
- Non-target users do not see the event in their feed; targeted users do.
- Repair script creates sheets for legacy events without sheets.
- Temporary logs show the before/after targets and cascade results for one edit and one delete.