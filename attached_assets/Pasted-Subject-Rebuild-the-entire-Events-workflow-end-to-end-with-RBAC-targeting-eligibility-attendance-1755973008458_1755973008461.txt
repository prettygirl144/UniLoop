Subject: Rebuild the entire Events workflow end-to-end with RBAC, targeting, eligibility, attendance sheets, edit/delete, bulk actions, sync, and Excel export

Goals
- RBAC-gated event management.
- Target attendees by batch and section when creating/editing events.
- Compute eligibility and build a compiled attendee list automatically.
- Allow full edits (time, location, description, targets) and reflect changes in eligibility and attendee list immediately.
- Allow deletes with safe cascade.
- Attendance sheet per event with per-student statuses (Present, Absent, Late, Excused), remarks, bulk actions, live dashboard, sync with directory changes, and export to Excel.

Scope
- Implement in both backend and frontend.
- Replace the current events flow; keep data where compatible but migrate if needed.

RBAC
- Roles: admin, events_manager, student.
- Permissions:
  - events.manage (create, edit, delete, target audiences, attendance actions, export)
- Gate all write routes by requireAnyRole(['admin','events_manager']); reads require auth.

Data model (canonical, replace legacy)
- Event:
  - id, title, description, location, startsAt, endsAt, createdBy, tenantId
  - targets: { batches: string[], sections: string[], programs: string[] } // sections empty ⇒ all sections in selected batches
  - meta: { mandatory?: boolean, tags?: string[] }
  - createdAt, updatedAt
- AttendanceContainer:
  - id, eventId (unique), createdAt, updatedAt
  - summary: { total: number, present: number, absent: number, late: number, excused: number }
- AttendanceSheet:
  - id, eventId, batch: string, section: string
  - counts: { total, present, absent, late, excused }
- AttendanceRecord:
  - id, eventId, sheetId, userId, email, rollNumber, batch, section
  - status: 'UNMARKED' | 'PRESENT' | 'ABSENT' | 'LATE' | 'EXCUSED'
  - remark?: string
  - updatedAt
- StudentDirectory:
  - emailL, rollNumberU, batch, section, name, program

Backend APIs

Create event
- POST /api/events (RBAC: events.manage)
  - Body: { title, description, location, startsAt, endsAt, targets, meta }
  - Normalize targets: trim, dedupe, sort.
  - Save event.
  - Build attendee container:
    - For each batch in targets:
      - sections = targets.sections.length ? targets.sections : all sections from directory for that batch
      - For each section, create a sheet and populate AttendanceRecord for each student (status UNMARKED).
    - Compute counts; store container + sheet summaries.
  - Return event with counts.

List events (user feed)
- GET /api/events
  - If admin/events_manager: return all with eligible computed for current user.
  - Else: filter by eligibility: batch must match; sections empty ⇒ all; else section must match. Include eligible flag.

Event detail
- GET /api/events/:id
  - Return event + eligible flag + summary counts.

Edit event
- PATCH /api/events/:id (RBAC)
  - Allow all fields to change.
  - If targets changed:
    - Compute normalized new targets.
    - Rebuild attendee container atomically:
      - Delete all sheets/records for eventId.
      - Recreate sheets/records from directory based on new targets.
    - Update summaries.
  - Return updated event and summary.

Delete event
- DELETE /api/events/:id (RBAC)
  - Transaction: delete records → sheets → container → event.
  - 204 on success.

Attendance APIs
- GET /api/events/:id/attendance (RBAC)
  - Returns: container summary, per-sheet summaries, paginated records with filters (status, search).
- POST /api/events/:id/attendance/bulk (RBAC)
  - Body: { recordIds?: string[], filter?: {...}, status: 'PRESENT'|'ABSENT'|'LATE'|'EXCUSED', remark? }
  - Apply to selected records or filtered set. Update counts.
- PATCH /api/attendance/records/:recordId (RBAC)
  - Body: { status, remark }
  - Update record; bump sheet/container counts.
- POST /api/events/:id/attendance/sync (RBAC)
  - For each sheet’s batch/section:
    - Add new students from directory as UNMARKED.
    - Archive or keep historical? For now, keep records; do not delete. Mark orphaned ones with archived flag if needed and exclude from counts.
  - Return added/archived counts.
- GET /api/events/:id/attendance/export (RBAC)
  - Generate Excel with sheets as tabs, include per-sheet summaries and all records with status/remarks.

Helpers and constraints
- Eligibility helper (single source of truth):
  function isEligible(user, targets) {
    const batches = targets?.batches ?? [];
    const sections = targets?.sections ?? [];
    const programs = targets?.programs ?? [];
    if (batches.length === 0) return false;
    const batchOK = batches.includes(user.batch);
    const sectionOK = sections.length === 0 || sections.includes(user.section);
    const programOK = programs.length === 0 || programs.includes(user.program);
    return batchOK && sectionOK && programOK;
  }
- Directory normalization:
  - section stored as plain code 'A','B',...; batch stored as 'MBA 2025-27'.
  - If legacy section contains 'batch::section', split and fix via migration.
- Transactions: wrap create/edit/delete and bulk attendance updates in transactions.
- Indexes:
  - AttendanceContainer.eventId unique
  - AttendanceSheet: eventId + batch + section unique
  - AttendanceRecord: eventId + emailL unique per event

Frontend (Admin/Manager UI)

Event create/edit form
- Fields: title, description, location, startsAt, endsAt, tags, mandatory.
- Targeting:
  - Batch multi-select (from directory distinct batches).
  - Section multi-select:
    - If none selected ⇒ all sections in selected batches.
    - If one or more selected ⇒ restrict to those across selected batches.
- Save sends full targets arrays. On success:
  - Navigate to event detail and refetch lists.

Event list
- Tabs: All (admin/managers), My eligible (students).
- Cards show: title, date/time, location, eligible badge for students, summary counts (present/absent/late/excused).

Event detail (admin/manager)
- Show event info and targets.
- Attendee dashboard:
  - Summary tiles: total, present, absent, late, excused.
  - Filters: section(s), status, search.
  - Table: name, roll, email, batch, section, status selector, remark input.
  - Bulk actions: set status for selected/filtered, add remark.
  - Buttons: Sync from Directory, Export to Excel.
  - Real-time count updates after actions.

Student view
- Sees only eligible events.
- No attendance actions.

Cache and SW
- After POST/PATCH/DELETE/attendance updates:
  - Invalidate: ['events','adminList'], ['events','userFeed'], ['events',id], ['attendance',id].
- Use network-first for GET events and attendance during rollout.

Migrations and repair
- One-time migration:
  - Convert legacy targetBatchSections to targets.batches + targets.sections.
  - Normalize directory section to plain code; fill missing program if needed.
  - Build AttendanceContainer/Sheets/Records for existing events based on normalized targets.
- Repair endpoint (admin-only): rebuild attendance for event idempotently.

Validation and error handling
- Validate dates (startsAt < endsAt), required fields, non-empty title.
- Validate targets: at least one batch.
- Clear 400 messages on invalid field or unknown batch/section code.
- 403 for RBAC violations.

Acceptance tests (must pass)
1) Create event targeting MBA 2025-27 with no sections:
   - Eligible only for that batch (any section).
   - Attendance sheets exist for all sections in that batch; records populated.
2) Edit event to sections C and D only:
   - Eligibility flips accordingly; attendance rebuilt to only C and D.
3) Bulk mark D section as Present; counts update in dashboard.
4) Sync after adding a new student in C via directory upload; new record appears as UNMARKED.
5) Export Excel: one tab per section with correct statuses and counts.
6) Delete event: removes event and all attendance artifacts; student feed no longer shows it.

Deliverables
- List of backend files created/updated (models, routes, services, eligibility helper, migrations).
- List of frontend files created/updated (pages, components, hooks).
- Screenshots: event detail dashboard, Excel export, student feed eligibility correctness.
- Logs from one run showing eligibility evaluation and attendance rebuild counts for an edited event.